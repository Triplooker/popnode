#!/bin/bash

echo "üîÑ –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ POP –Ω–æ–¥—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö"
echo "================================================="

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –Ω–æ–¥—ã, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
DATA_DIR="/root/popnode_data"
if [ ! -d "$DATA_DIR" ]; then
    echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –Ω–æ–¥—ã: $DATA_DIR"
    mkdir -p "$DATA_DIR"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä popnode
if docker ps -a | grep -q popnode; then
    echo "üìã –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä popnode"
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
    docker stop popnode > /dev/null 2>&1
    
    # –ù–ï —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    echo "‚è∏Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
    docker start popnode
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
        
        # –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (10 —Å–µ–∫—É–Ω–¥)..."
        sleep 10
        
        # –ü–æ–ª—É—á–∞–µ–º POP ID
        echo ""
        echo "üÜî –ü–æ–ª—É—á–∞–µ–º POP ID..."
        POP_ID=$(docker exec popnode curl -sk https://localhost/state 2>/dev/null | grep -o '"pop_id":"[^"]*"' | cut -d'"' -f4)
        
        if [ ! -z "$POP_ID" ] && [ "$POP_ID" != "null" ]; then
            echo "üéØ POP ID: $POP_ID"
            echo ""
            echo "üìà –î–ê–®–ë–û–†–î –ù–û–î–´:"
            echo "üîó https://dashboard.testnet.pipe.network/node/$POP_ID"
        else
            echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å POP ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."
        fi
        
        echo ""
        echo "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
        docker logs popnode --tail 10
        
        exit 0
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"
        echo "üîÑ –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
        docker rm popnode > /dev/null 2>&1
    fi
else
    echo "‚ÑπÔ∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä popnode –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, –∑–Ω–∞—á–∏—Ç –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo ""
echo "üîë –í–≤–µ–¥–∏—Ç–µ invite –∫–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:"
read -p "Invite –∫–æ–¥: " INVITE_CODE

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ invite –∫–æ–¥ –Ω–µ –ø—É—Å—Ç–æ–π
if [ -z "$INVITE_CODE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: Invite –∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"
    exit 1
fi

echo ""
echo "üöÄ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö..."
echo "üåê –ü–æ—Ä—Ç—ã: 80 (HTTP) –∏ 443 (HTTPS) –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑–≤–Ω–µ"
echo "üíæ –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $DATA_DIR"

# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å volume –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
docker run -d --name popnode --restart unless-stopped \
    -p 80:80 -p 443:443 \
    -v "$DATA_DIR:/app/data" \
    -e POP_INVITE_CODE="$INVITE_CODE" \
    popnode sh -c "./pop"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    
    # –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (15 —Å–µ–∫—É–Ω–¥)..."
    sleep 15
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    if docker ps | grep -q popnode; then
        echo "üéâ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ä—Ç–∞—Ö
        echo ""
        echo "üîå –ü—Ä–æ–±—Ä–æ—à–µ–Ω–Ω—ã–µ –ø–æ—Ä—Ç—ã:"
        docker port popnode
        
        echo ""
        echo "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
        docker logs popnode --tail 10
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–Ω–∞—Ä—É–∂–∏
        echo ""
        echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–Ω–∞—Ä—É–∂–∏..."
        
        if curl -s --connect-timeout 3 http://localhost/ > /dev/null 2>&1; then
            echo "‚úÖ HTTP (–ø–æ—Ä—Ç 80) –¥–æ—Å—Ç—É–ø–µ–Ω —Å–Ω–∞—Ä—É–∂–∏"
        else
            echo "‚ùå HTTP (–ø–æ—Ä—Ç 80) –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω —Å–Ω–∞—Ä—É–∂–∏"
        fi
        
        if curl -sk --connect-timeout 3 https://localhost/ > /dev/null 2>&1; then
            echo "‚úÖ HTTPS (–ø–æ—Ä—Ç 443) –¥–æ—Å—Ç—É–ø–µ–Ω —Å–Ω–∞—Ä—É–∂–∏"
        else
            echo "‚ùå HTTPS (–ø–æ—Ä—Ç 443) –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω —Å–Ω–∞—Ä—É–∂–∏"
        fi
        
        # –ü–æ–ª—É—á–∞–µ–º POP ID –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–∞—à–±–æ—Ä–¥
        echo ""
        echo "üÜî –ü–æ–ª—É—á–∞–µ–º POP ID..."
        sleep 5
        
        POP_ID=$(docker exec popnode curl -sk https://localhost/state 2>/dev/null | grep -o '"pop_id":"[^"]*"' | cut -d'"' -f4)
        
        if [ ! -z "$POP_ID" ] && [ "$POP_ID" != "null" ]; then
            echo "üéØ POP ID: $POP_ID"
            echo ""
            echo "üìà –î–ê–®–ë–û–†–î –ù–û–î–´:"
            echo "üîó https://dashboard.testnet.pipe.network/node/$POP_ID"
            echo ""
            echo "üìã –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–∞—à–µ–π –Ω–æ–¥—ã!"
            echo "üíæ –î–∞–Ω–Ω—ã–µ –Ω–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ $DATA_DIR"
        else
            echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å POP ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç:"
            echo "   docker exec popnode curl -sk https://localhost/state | grep pop_id"
        fi
        
    else
        echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –õ–æ–≥–∏:"
        docker logs popnode --tail 20
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"
    exit 1
fi

echo ""
echo "üéØ –ì–æ—Ç–æ–≤–æ! –í–∞—à–∞ CDN –Ω–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑–≤–Ω–µ –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 80 –∏ 443"
echo "üí° –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ POP ID –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"
