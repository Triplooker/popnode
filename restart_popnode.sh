#!/bin/bash

echo "üîÑ –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ POP –Ω–æ–¥—ã"
echo "================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä popnode
if docker ps -a | grep -q popnode; then
    echo "üìã –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä popnode"
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
    docker stop popnode >/dev/null 2>&1
    docker rm popnode >/dev/null 2>&1
    echo "‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª–µ–Ω"
else
    echo "‚ÑπÔ∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä popnode –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º invite –∫–æ–¥
echo ""
echo "üîë –í–≤–µ–¥–∏—Ç–µ invite –∫–æ–¥ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:"
read -p "Invite –∫–æ–¥: " INVITE_CODE

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ invite –∫–æ–¥ –Ω–µ –ø—É—Å—Ç–æ–π
if [ -z "$INVITE_CODE" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: Invite –∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!"
    exit 1
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å invite –∫–æ–¥–æ–º..."

# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker run -d --name popnode --restart unless-stopped -e POP_INVITE_CODE="$INVITE_CODE" popnode sh -c "rm -f .pop.lock 2>/dev/null; ./pop"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    
    # –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (5 —Å–µ–∫—É–Ω–¥)..."
    sleep 5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    if docker ps | grep -q popnode; then
        echo "üéâ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!"
        echo ""
        echo "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
        docker logs popnode --tail 10
        echo ""
        echo "üîç –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
        echo "docker exec popnode curl -sk https://localhost/"
    else
        echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –õ–æ–≥–∏:"
        docker logs popnode --tail 20
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"
    exit 1
fi
